#!/usr/bin/env perl

use Modern::Perl;
use REST::Google::Search qw/ LOCAL /;
use Crypt::SaltedHash;
use Try::Tiny;
use DateTime::Format::ISO8601;
use HTML::FormatText;

use lib 'lib';
use After5::Model;

our $MODEL = After5::Model->connect('dbi:SQLite:after5detroit.db');

use Mojolicious::Lite;
use Mojo::Util;

any '/' => sub {

    my $self = shift;
    return $self->redirect_to('home');
};

### After5 Pages

get '/home' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%ad%'}})->all;

    $self->{'ADS'} = \@ads;

    # Features
    my @features =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, tags => {like => '%featured%'}},
        {order_by => 'id DESC'})->all;

    $self->{'FEATURES'} = \@features;

    # Features by Position
    my @positions = $MODEL->resultset('Content')->search(
        {   pages    => {like => '%home%'},
            position => {like => ['%1%', '%2%', '%3%']}
        }
    )->all;

    $self->{'POSITIONS'} = \@positions;

    # City Life
    my @city_life =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%home%'}, interests => {like => '%living%'}},
        {order_by => 'id DESC'})->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Galleries
    my @galleries =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%gallery%'}},
        {order_by => 'id DESC'})->all;

    $self->{'GALLERIES'} = \@galleries;

    return $self->render('home');

} => 'home';

get '/live' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%live%'}, types => {like => '%ad%'}})->all;

    $self->{'ADS'} = \@ads;

    # City Life
    my @city_life = $MODEL->resultset('Content')->search(
        {pages     => {like => '%live%'}, interests => {like => '%living%'}},
        {order_by  => 'id DESC'}
    )->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Lifestyle
    my @lifestyle = $MODEL->resultset('Content')->search(
        {pages    => {like => '%live%'}, types    => {like => '%place%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'LIFESTYLE'} = \@lifestyle;

    # Neighbors
    my @neighbors = $MODEL->resultset('Content')->search(
        {pages    => {like => '%live%'}, types    => {like => '%people%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'NEIGHBORS'} = \@neighbors;

    return $self->render('live');

} => 'live';

get '/live/birmingham' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%live%'}, types => {like => '%ad%'}})->all;

} => 'live_birmingham';

get '/live/detroit' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%live%'}, types => {like => '%ad%'}})->all;

} => 'live_detroit';

get '/live/ferndale' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%live%'}, types => {like => '%ad%'}})->all;

} => 'live_ferndale';

get '/live/royal_oak' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%live%'}, types => {like => '%ad%'}})->all;

} => 'live_royal_oak';

get '/work' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%work%'}, types => {like => '%ad%'}})->all;

    $self->{'ADS'} = \@ads;

    return $self->render('work');

} => 'work';

get '/work/careers' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%work%'}, types => {like => '%ad%'}})->all;

} => 'work_careers';

get '/work/professional_development' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%work%'}, types => {like => '%ad%'}})->all;

} => 'work_professional_development';

get '/play' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, types => {like => '%ad%'}})->all;

    $self->{'ADS'} = \@ads;

    # Features
    my @features = $MODEL->resultset('Content')->search(
        {pages    => {like => '%play%'}, types => {like => '%people%'}, tags => {like => '%featured%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'FEATURES'} = \@features;

    # Buzz
    my @buzz = $MODEL->resultset('Content')->search(
        {pages    => {like => '%play%'}, tags => {like => '%the_buzz%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'BUZZ'} = \@buzz;

    # Places
    my @places = $MODEL->resultset('Content')->search(
        {pages    => {like => '%play%'}, types    => {like => '%place%'}, tags => {like => '%try_this%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'PLACES'} = \@places;

    # Events
    my @events =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%event%'}},
        {order_by => 'id DESC'})->all;

    $self->{'EVENTS'} = \@events;

    return $self->render('play');

} => 'play';

get '/play/features' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, types => {like => '%ad%'}})->all;

    # Features
    my @features = $MODEL->resultset('Content')->search(
        {types => {like => '%people%'}, tags => {like => '%featured%'}},
        {page => 1, rows => 1, order_by => 'id DESC'},
    )->all;

    $self->{'FEATURES'} = \@features;

    # Past Articles
    my @past_articles = $MODEL->resultset('Content')->search(
        {types => {like => '%people%'}, tags => {like => '%featured%'}},
        {page => 1, rows => 5, order_by => 'id DESC'},
    )->all;

    $self->{'PAST_ARTICLES'} = \@past_articles;
    
    return $self->render('play_features');

} => 'play_features';

get '/play/places' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, types => {like => '%ad%'}})->all;

    # Try This!
    my @try_this = $MODEL->resultset('Content')->search(
        {types    => {like => '%place%'}, tags => {like => '%try_this%'}},
        {order_by => 'id DESC'},
    )->all;

    $self->{'TRY_THIS'} = \@try_this;

    # More Places
    my @more_places = $MODEL->resultset('Content')->search(
        {types => {like => '%place%'}}, {order_by => 'id DESC'},
    )->all;

    $self->{'MORE_PLACES'} = \@more_places;

    return $self->render('play_places');

} => 'play_places';

get '/play/buzz' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, types => {like => '%ad%'}})->all;

    # The Buzz
    my @the_buzz = $MODEL->resultset('Content')->search(
        {tags => {like => '%the_buzz%'}},
        {page => 1, rows => 3, order_by => 'id DESC'},
    )->all;

    $self->{'THE_BUZZ'} = \@the_buzz;

    # More Buzz
    my @more_buzz = $MODEL->resultset('Content')->search(
        {tags => {like => '%the_buzz%'}},
        {page => 1, rows => 5, order_by => 'id DESC'},
    )->all;

    $self->{'MORE_BUZZ'} = \@more_buzz;

    return $self->render('play_buzz');
    
} => 'play_buzz';

get '/play/events' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, types => {like => '%ad%'}})->all;

    # Featured Event
    my @featured_event = $MODEL->resultset('Content')->search(
        {types    => {like => '%event%'}},
        {tags     => {like => '%featured%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_EVENT'} = \@featured_event;

    # Upcoming Events
    my @upcoming_events =
      $MODEL->resultset('Content')
      ->search({types => {like => '%event%'}}, {order_by => 'id DESC'})->all;

    $self->{'UPCOMING_EVENTS'} = \@upcoming_events;

} => 'play_events';

get '/photos' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%photos%'}, types => {like => '%ad%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    # Galleries
    my @galleries =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%photos%'}}, {order_by => 'id DESC'})->all;

    $self->{'GALLERIES'} = \@galleries;

    return $self->render('photos');

} => 'photos';

get '/about' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%about%'}, types => {like => '%ad%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    return $self->render('about');

} => 'about';

get '/about/contact' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => 'about'}, types => {like => '%ad%'}})->all;

} => 'about_contact';

get '/about/newsletter' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%about%'}, types => {like => '%ad%'}})
      ->all;

} => 'about_newsletter';

any '/search' => sub {

    my $self = shift;
    $self->{'MODEL'} = $MODEL;

    # Ad Content
    $self->{'ad_content'} = 'search';

    return $self->render('search');

} => 'search';

any '/more' => sub {

    my $self = shift;

    my (@ads, @more);

    # Ads
    @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%more%'}, types => {like => '%ad%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    if ($self->param('id')) {

        @more =
          $MODEL->resultset('Content')->search({id => $self->param('id')});
        $self->{'MORE'} = \@more;
    }

    if ($self->param('featured')) {

        @more =
          $MODEL->resultset('Content')
          ->search({tags => {like => '%featured%'}}, {order_by => 'id DESC'})
          ->all;
        $self->{'MORE'} = \@more;
    }

    if ($self->param('living')) {

        @more =
          $MODEL->resultset('Content')
          ->search({interests => {like => '%living%'}},
            {order_by => 'id DESC'})->all;
        $self->{'MORE'} = \@more;
    }

    if ($self->param('galleries')) {

        @more =
          $MODEL->resultset('Content')
          ->search({types => {like => '%gallery%'}}, {order_by => 'id DESC'})
          ->all;
        $self->{'MORE'} = \@more;
    }

    return $self->render('more');

} => 'more';

### After5 Control Panel

get '/cpanel' => sub {

    my $self = shift;

    # Ad Content
    $self->{'ad_content'} = '';    # Setting this blank...

    # Content
    my @content =
      $MODEL->resultset('Content')->search({}, {order_by => 'id DESC'})->all;
    $self->{'CONTENT'} = \@content;

    # Settings
    my $settings = $MODEL->resultset('Settings')->first;
    $self->{'SETTINGS'} = $settings;

    return $self->render('cpanel');

} => 'cpanel';

## CPanel: Content

any '/cpanel/content/form' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    # Ad Content
    $self->{'ad_content'} = '';    # Setting this blank...

    # Content
    my $content =
      $MODEL->resultset('Content')->search({id => $self->param('id')})
      ->single;
    $self->{'CONTENT'} = $content;

    # Recent Content
    my @recent_content =
      $MODEL->resultset('Content')->search({}, {order_by => 'id DESC'})->all;
    $self->{'RECENT_CONTENT'} = \@recent_content;

    return $self->render('cpanel_content_form');

} => 'cpanel_content_form';

any '/cpanel/content/create' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    my (@tags, @cities, @types, @interests, @pages, @photos);

    try {

        my $new_content = $MODEL->resultset('Content')->create(

            {   author   => $self->param('author'),
                title    => $self->param('title'),
                datetime => DateTime->now,
            }
        );

        if (($self->param('start_date')) and ($self->param('start_time'))) {

            my $start_datetime = DateTime::Format::ISO8601->parse_datetime(
                $self->param('start_date') . $self->param('start_time'));

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({start_datetime => $start_datetime});

            my $stop_datetime = DateTime::Format::ISO8601->parse_datetime(
                $self->param('stop_date') . $self->param('stop_time'));

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({stop_datetime => $stop_datetime});


        }

        if ($self->param('body')) {

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({body => $self->param('body')});
        }

        if ($self->param('interests')) {

            push @interests, $_ for $self->param('interests');

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({interests => "@interests"});
        }

        if ($self->param('pages')) {

            push @pages, $_ for $self->param('pages');

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({pages => "@pages"});
        }

        if ($self->param('types')) {

            push @types, $_ for $self->param('types');

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({types => "@types"});
        }

        if ($self->param('tags')) {

            push @tags, $_ for $self->param('tags');

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({tags => "@tags"});
        }

        if ($self->param('cities')) {

            push @cities, $_ for $self->param('cities');

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({cities => "@cities"});
        }

        if ($self->param('position')) {

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update({position => $self->param('position')});
        }

        push @photos, process_photo($self->req->upload('photo1'))
          if $self->req->upload('photo1');

        push @photos, process_photo($self->req->upload('photo2'))
          if $self->req->upload('photo2');

        push @photos, process_photo($self->req->upload('photo3'))
          if $self->req->upload('photo3');

        push @photos, process_photo($self->req->upload('photo4'))
          if $self->req->upload('photo4');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({photos => "@photos", datetime => DateTime->now})
          if scalar @photos >= 1;

    }

    finally {

        $self->redirect_to('cpanel');
    }

};

any '/cpanel/content/update' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    my (@tags, @cities, @types, @interests, @pages, @photos);

    try {

        if (($self->param('start_date')) and ($self->param('start_time'))) {

            my $start_datetime = DateTime::Format::ISO8601->parse_datetime(
                $self->param('start_date') . $self->param('start_time'));

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({start_datetime => $start_datetime});

            my $stop_datetime = DateTime::Format::ISO8601->parse_datetime(
                $self->param('stop_date') . $self->param('stop_time'));

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({stop_datetime => $stop_datetime});

        }

        if ($self->param('author')) {

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({author => $self->param('author')});
        }

        if ($self->param('title')) {

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({title => $self->param('title')});
        }

        if ($self->param('body')) {

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({body => $self->param('body')});
        }

        if ($self->param('interests')) {

            push @interests, $_ for $self->param('interests');

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({interests => "@interests"});
        }

        if ($self->param('pages')) {

            push @pages, $_ for $self->param('pages');

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({pages => "@pages"});
        }

        if ($self->param('types')) {

            push @types, $_ for $self->param('types');

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({types => "@types"});
        }

        if ($self->param('tags')) {

            push @tags, $_ for $self->param('tags');

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({tags => "@tags"});
        }

        if ($self->param('cities')) {

            push @cities, $_ for $self->param('cities');

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({cities => "@cities"});
        }

        if ($self->param('position')) {

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update({position => $self->param('position')});
        }

        push @photos, process_photo($self->req->upload('photo1'))
          if $self->req->upload('photo1');

        push @photos, process_photo($self->req->upload('photo2'))
          if $self->req->upload('photo2');

        push @photos, process_photo($self->req->upload('photo3'))
          if $self->req->upload('photo3');

        push @photos, process_photo($self->req->upload('photo4'))
          if $self->req->upload('photo4');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({photos => "@photos", datetime => DateTime->now})
          if scalar @photos >= 1;

    }

    finally {

        $self->redirect_to('cpanel');
    }

};

any '/cpanel/content/remove' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    try {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->delete;
    }

    finally {

        $self->redirect_to('cpanel');
    }

};

## CPanel: After5 Admin

any '/cpanel/login' => sub {

    my $self = shift;

    try {

        my @settings =
          $MODEL->resultset('Settings')
          ->search({admin => $self->param('admin')});

        for (@settings) {

            if (Crypt::SaltedHash->validate(
                    $_->password, $self->param('password')
                )
              )
            {

                $self->session(admin => $_->admin);
                $self->redirect_to('cpanel');
            }
        }
    }

    finally {

        $self->redirect_to('cpanel');
    }

} => 'cpanel_login';

get '/cpanel/logout' => sub {

    my $self = shift;

    $self->session(expires => 1)
      and return $self->redirect_to('home');

} => 'cpanel_logout';

any '/cpanel/settings' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    try {

        $MODEL->resultset('Settings')
          ->update({admin => $self->param('admin')});

        if (    ($self->param('password_1') ne '')
            and ($self->param('password_1') eq $self->param('password_2')))
        {

            my $crypt = Crypt::SaltedHash->new(algorithm => 'SHA-256');
            $crypt->add($self->param('password_1'));

            my $password = $crypt->generate;

            $MODEL->resultset('Settings')->update({password => $password});
        }

        $MODEL->resultset('Settings')
          ->update({about => $self->param('about')});
    }

    finally {

        $self->redirect_to('cpanel');
    }

} => 'cpanel_settings';

### After5 Tools

sub process_photo {

    my $upload = shift;

    my $path = '/photos/' . $upload->filename;

    $upload->move_to('public' . $path);

    return $path;
}

sub google_local {

    REST::Google::Search->service(LOCAL);

    my $response = REST::Google::Search->new(q => shift);

    if ($response->responseStatus == 200) {

        my $data = $response->responseData;
        return $data->results;
    }

}

sub randomize_content {

    my @array = shift;
    my $i     = $#array;
    my $j;

    for my $item (@array) {

        --$i;
        $j = int rand($i + 1);
        next if $i == $j;
        @array[$i, $j] = @array[$j, $i];
    }
    return \@array;

}


app->secret('after5detroit.com');
app->start;
