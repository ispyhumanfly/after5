#!/usr/bin/env perl

use Modern::Perl;
use REST::Google::Search qw/ LOCAL /;
use Crypt::SaltedHash;
use Try::Tiny;
use DateTime::Format::ISO8601;
use HTML::FormatText;
use Archive::Extract;
use File::Copy;
use Encode;

use lib 'lib';
use After5::Model;

our $MODEL = After5::Model->connect('dbi:SQLite:after5detroit.db');

use Mojolicious::Lite;
use Mojo::Util;

any '/' => sub {

    my $self = shift;
    return $self->redirect_to('home');
};

### After5 Pages

get '/home' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%home%'}, types => {like => '%ad_header%'}})->all;

    $self->{'ADS'} = \@ads;

    # Features
    my @features =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%article%'}},
        {order_by => 'id DESC'})->all;

    $self->{'FEATURES'} = \@features;

    # Features by Position
    my @positions = $MODEL->resultset('Content')->search(
        {   pages    => {like => '%home%'},
            position => {like => ['%1%', '%2%', '%3%']}
        }
    )->all;

    $self->{'POSITIONS'} = \@positions;

    # City Life
    my @city_life =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%home%'}, tags => {like => '%city_life%'}},
        {order_by => 'id DESC'})->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Galleries
    my @galleries =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%gallery%'}},
        {order_by => 'id DESC'})->all;

    $self->{'GALLERIES'} = \@galleries;

    return $self->render('home');

} => 'home';

get '/live' => sub {

    my $self = shift;

    # Until more Live related content is available. We will
    # default to /live/detroit.

    ## Ads
    #my @ads =
    #  $MODEL->resultset('Content')
    #  ->search(
    #    {pages => {like => '%live%'}, types => {like => '%ad_header%'}})->all;
    #
    #$self->{'ADS'} = \@ads;
    #
    ## City Life
    #my @city_life =
    #  $MODEL->resultset('Content')
    #  ->search(
    #    {pages => {like => '%live%'}, interests => {like => '%living%'}},
    #    {order_by => 'id DESC'})->all;
    #
    #$self->{'CITY_LIFE'} = \@city_life;
    #
    ## Lifestyle
    #my @lifestyle =
    #  $MODEL->resultset('Content')
    #  ->search({pages => {like => '%live%'}, types => {like => '%place%'}},
    #    {order_by => 'id DESC'})->all;
    #
    #$self->{'LIFESTYLE'} = \@lifestyle;
    #
    ## Neighbors
    #my @neighbors =
    #  $MODEL->resultset('Content')
    #  ->search({pages => {like => '%live%'}, types => {like => '%people%'}},
    #    {order_by => 'id DESC'})->all;
    #
    #$self->{'NEIGHBORS'} = \@neighbors;
    #
    #return $self->render('live');

    return $self->redirect_to('live_detroit');

} => 'live';

get '/live/birmingham' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%live%'}, types => {like => '%ad_header%'}})->all;

    # City Life
    my @city_life = $MODEL->resultset('Content')->search(
        {   pages => {like => '%live%'},
            tags  => {like => '%city_life%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Featured Lifestyle
    my @featured_lifestyle = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            tags   => {like => '%lifestyle%'},
            cities => {like => '%birmingham%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_LIFESTYLE'} = \@featured_lifestyle;

    # Neighbors
    my @neighbors = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            types  => {like => '%article%'},
            tags   => {like => '%neighbor%'},
            cities => {like => '%birmingham%'}
        },
        {page => 1, rows => 5, order_by => 'id DESC'}
    )->all;

    $self->{'NEIGHBORS'} = \@neighbors;

    return $self->render('live_birmingham');

} => 'live_birmingham';

get '/live/detroit' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%live%'}, types => {like => '%ad_header%'}})->all;

    # City Life
    my @city_life = $MODEL->resultset('Content')->search(
        {   pages => {like => '%live%'},
            tags  => {like => '%city_life%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Featured Lifestyle
    my @featured_lifestyle = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            tags   => {like => '%lifestyle%'},
            cities => {like => '%detroit%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_LIFESTYLE'} = \@featured_lifestyle;

    # Neighbors
    my @neighbors = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            types  => {like => '%article%'},
            tags   => {like => '%neighbor%'},
            cities => {like => '%detroit%'}
        },
        {page => 1, rows => 5, order_by => 'id DESC'}
    )->all;

    $self->{'NEIGHBORS'} = \@neighbors;

    return $self->render('live_detroit');

} => 'live_detroit';

get '/live/ferndale' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%live%'}, types => {like => '%ad_header%'}})->all;

    # City Life
    my @city_life = $MODEL->resultset('Content')->search(
        {   pages => {like => '%live%'},
            tags  => {like => '%city_life%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Featured Lifestyle
    my @featured_lifestyle = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            tags   => {like => '%lifestyle%'},
            cities => {like => '%ferndale%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_LIFESTYLE'} = \@featured_lifestyle;

    # Neighbors
    my @neighbors = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            types  => {like => '%article%'},
            tags   => {like => '%neighbor%'},
            cities => {like => '%ferndale%'}
        },
        {page => 1, rows => 5, order_by => 'id DESC'}
    )->all;

    $self->{'NEIGHBORS'} = \@neighbors;

    return $self->render('live_ferndale');

} => 'live_ferndale';

get '/live/royal_oak' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%live%'}, types => {like => '%ad_header%'}})->all;

    # City Life
    my @city_life = $MODEL->resultset('Content')->search(
        {   pages => {like => '%live%'},
            tags  => {like => '%city_life%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'CITY_LIFE'} = \@city_life;

    # Featured Lifestyle
    my @featured_lifestyle = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            tags   => {like => '%lifestyle%'},
            cities => {like => '%royal_oak%'}
        },
        {page => 1, rows => 1, order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_LIFESTYLE'} = \@featured_lifestyle;

    # Neighbors
    my @neighbors = $MODEL->resultset('Content')->search(
        {   pages  => {like => '%live%'},
            types  => {like => '%article%'},
            tags   => {like => '%neighbor%'},
            cities => {like => '%royal_oak%'}
        },
        {page => 1, rows => 5, order_by => 'id DESC'}
    )->all;

    $self->{'NEIGHBORS'} = \@neighbors;

    return $self->render('live_royal_oak');

} => 'live_royal_oak';

get '/work' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%work%'}, types => {like => '%ad_header%'}})->all;

    $self->{'ADS'} = \@ads;

    return $self->render('work');

} => 'work';

get '/work/careers' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%work%'}, types => {like => '%ad_header%'}})->all;

} => 'work_careers';

get '/work/professional_development' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%work%'}, types => {like => '%ad_header%'}})->all;

} => 'work_professional_development';

get '/play' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%play%'}, types => {like => '%ad_header%'}})->all;

    $self->{'ADS'} = \@ads;

    # Features
    my @features = $MODEL->resultset('Content')->search(
        {   pages => {like => '%play%'},
            types => {like => '%article%'},
            tags  => {like => '%people%'}
        },
        {order_by => 'id DESC'}
    )->all;

    $self->{'FEATURES'} = \@features;

    # Buzz
    my @buzz =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%play%'}, tags => {like => '%the_buzz%'}},
        {order_by => 'id DESC'})->all;

    $self->{'BUZZ'} = \@buzz;

    # Places
    my @places = $MODEL->resultset('Content')->search(
        {   pages => {like => '%play%'},
            types => {like => '%place%'},
            tags  => {like => '%try_this%'}
        },
        {order_by => 'id DESC'}
    )->all;

    $self->{'PLACES'} = \@places;

    # Events
    my @events =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%home%'}, types => {like => '%event%'}},
        {order_by => 'id DESC'})->all;

    $self->{'EVENTS'} = \@events;

    return $self->render('play');

} => 'play';

get '/play/features' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%play%'}, types => {like => '%ad_header%'}})->all;

    # Features
    my @features = $MODEL->resultset('Content')->search(
        {types => {like => '%article%'}, tags => {like => '%people%'}},
        {page => 1, rows => 3, order_by => 'id DESC'},
    )->all;

    $self->{'FEATURES'} = \@features;

    # Past Articles
    my @past_articles = $MODEL->resultset('Content')->search(
        {types => {like => '%article%'}, tags => {like => '%people%'}},
        {page => 2, rows => 3, order_by => 'id DESC'},
    )->all;

    $self->{'PAST_ARTICLES'} = \@past_articles;

    return $self->render('play_features');

} => 'play_features';

get '/play/places' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%play%'}, types => {like => '%ad_header%'}})->all;

    # Try This!
    my @try_this = $MODEL->resultset('Content')->search(
        {types => {like => '%place%'}, tags => {like => '%try_this%'}},
        {order_by => 'id DESC'},
    )->all;

    $self->{'TRY_THIS'} = \@try_this;

    # More Places
    my @more_places =
      $MODEL->resultset('Content')
      ->search({types => {like => '%place%'}}, {order_by => 'id DESC'},)->all;

    $self->{'MORE_PLACES'} = \@more_places;

    return $self->render('play_places');

} => 'play_places';

get '/play/buzz' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%play%'}, types => {like => '%ad_header%'}})->all;

    # The Buzz
    my @the_buzz = $MODEL->resultset('Content')->search(
        {tags => {like => '%the_buzz%'}},
        {page => 1, rows => 3, order_by => 'id DESC'},
    )->all;

    $self->{'THE_BUZZ'} = \@the_buzz;

    # More Buzz
    my @more_buzz = $MODEL->resultset('Content')->search(
        {tags => {like => '%the_buzz%'}},
        {page => 1, rows => 5, order_by => 'id DESC'},
    )->all;

    $self->{'MORE_BUZZ'} = \@more_buzz;

    return $self->render('play_buzz');

} => 'play_buzz';

get '/play/events' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%play%'}, types => {like => '%ad_header%'}})->all;

    # Featured Event
    my @featured_event = $MODEL->resultset('Content')->search(
        {types    => {like => '%event%'}},
        {tags     => {like => '%featured%'}},
        {order_by => 'id DESC'}
    )->all;

    $self->{'FEATURED_EVENT'} = \@featured_event;

    # Upcoming Events
    my @upcoming_events =
      $MODEL->resultset('Content')
      ->search({types => {like => '%event%'}}, {order_by => 'id DESC'})->all;

    $self->{'UPCOMING_EVENTS'} = \@upcoming_events;

} => 'play_events';

get '/photos' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%photos%'}, types => {like => '%ad_header%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    # Galleries
    my @galleries =
      $MODEL->resultset('Content')
      ->search({pages => {like => '%photos%'}}, {order_by => 'id DESC'})->all;

    $self->{'GALLERIES'} = \@galleries;

    return $self->render('photos');

} => 'photos';

get '/about' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%about%'}, types => {like => '%ad_header%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    return $self->render('about');

} => 'about';

get '/about/contact' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search({pages => {like => 'about'}, types => {like => '%ad_header%'}})
      ->all;

} => 'about_contact';

get '/about/newsletter' => sub {

    my $self = shift;

    # Ads
    my @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%about%'}, types => {like => '%ad_header%'}})
      ->all;

} => 'about_newsletter';

any '/search' => sub {

    my $self = shift;
    $self->{'MODEL'} = $MODEL;

    # Ad Content
    $self->{'ad_content'} = 'search';

    return $self->render('search');

} => 'search';

any '/more' => sub {

    my $self = shift;

    my (@ads, @more);

    # Ads
    @ads =
      $MODEL->resultset('Content')
      ->search(
        {pages => {like => '%more%'}, types => {like => '%ad_header%'}},
        {order_by => 'id DESC'})->all;

    $self->{'ADS'} = \@ads;

    if ($self->param('id')) {

        @more =
          $MODEL->resultset('Content')->search({id => $self->param('id')});
        $self->{'MORE'} = \@more;
    }

    if ($self->param('featured')) {

        @more =
          $MODEL->resultset('Content')
          ->search({tags => {like => '%featured%'}}, {order_by => 'id DESC'})
          ->all;
        $self->{'MORE'} = \@more;
    }

    if ($self->param('living')) {

        @more =
          $MODEL->resultset('Content')
          ->search({interests => {like => '%living%'}},
            {order_by => 'id DESC'})->all;
        $self->{'MORE'} = \@more;
    }

    if ($self->param('galleries')) {

        @more =
          $MODEL->resultset('Content')
          ->search({types => {like => '%gallery%'}}, {order_by => 'id DESC'})
          ->all;
        $self->{'MORE'} = \@more;
    }

    return $self->render('more');

} => 'more';

### After5 Content Panel

get '/cpanel' => sub {

    my $self = shift;

    # Ad Content
    $self->{'ad_content'} = '';    # Setting this blank...

    # Content
    my @content =
      $MODEL->resultset('Content')->search({}, {order_by => 'id DESC'})->all;
    $self->{'CONTENT'} = \@content;

    # Quick Edits
    my @quick_edits =
      $MODEL->resultset('Content')
      ->search({},
        {page => 1, rows => 15, order_by => 'modified_datetime DESC'})->all;
    $self->{'QUICK_EDITS'} = \@quick_edits;

    # Settings
    my $settings = $MODEL->resultset('Settings')->first;
    $self->{'SETTINGS'} = $settings;

    return $self->render('cpanel');

} => 'cpanel';

## CPanel: Content

any '/cpanel/content/form' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    # Ad Content
    $self->{'ad_content'} = '';    # Setting this blank...

    # Content
    my $content =
      $MODEL->resultset('Content')->search({id => $self->param('id')})
      ->single;
    $self->{'CONTENT'} = $content;

    # Quick Edits
    my @quick_edits =
      $MODEL->resultset('Content')
      ->search({},
        {page => 1, rows => 15, order_by => 'modified_datetime DESC'})->all;
    $self->{'QUICK_EDITS'} = \@quick_edits;

    return $self->render('cpanel_content_form');

} => 'cpanel_content_form';

any '/cpanel/content/create' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    my (@tags, @cities, @types, @interests, @pages, @photos);


    my $new_content =
      $MODEL->resultset('Content')
      ->create({create_datetime => DateTime->now});

    if (($self->param('start_date')) and ($self->param('start_time'))) {

        my $start_datetime = DateTime::Format::ISO8601->parse_datetime(
            $self->param('start_date') . $self->param('start_time'));

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({start_datetime => $start_datetime});

        my $stop_datetime = DateTime::Format::ISO8601->parse_datetime(
            $self->param('stop_date') . $self->param('stop_time'));

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({stop_datetime => $stop_datetime});


    }

    if ($self->param('author')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({author => $self->param('author')});
    }

    if ($self->param('title')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({title => $self->param('title')});
    }

    if ($self->param('body')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({body => encode_string($self->param('body'))});
    }

    if ($self->param('interests')) {

        push @interests, $_ for $self->param('interests');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({interests => "@interests"});
    }

    if ($self->param('pages')) {

        push @pages, $_ for $self->param('pages');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({pages => "@pages"});
    }

    if ($self->param('types')) {

        push @types, $_ for $self->param('types');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({types => "@types"});
    }

    if ($self->param('tags')) {

        push @tags, $_ for $self->param('tags');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({tags => "@tags"});
    }

    if ($self->param('cities')) {

        push @cities, $_ for $self->param('cities');

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({cities => "@cities"});
    }

    if ($self->param('position')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({position => $self->param('position')});
    }

    if ($self->param('link')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({link => $self->param('link')});
    }

    if ($self->param('address')) {

        my @results = google_local($self->param('address'));

        for (@results) {

            $MODEL->resultset('Content')->search({id => $new_content->id})
              ->update(
                {   address => $_->streetAddress . ', ' . $_->city,
                    lat     => $_->lat,
                    lng     => $_->lng
                }
              );
        }
    }

    if ($self->param('venue')) {

        $MODEL->resultset('Content')->search({id => $new_content->id})
          ->update({venue => $self->param('venue')});
    }

    push @photos,
      process_photo($self->req->upload('photos'), $new_content->id)
      if $self->req->upload('photos');

    $MODEL->resultset('Content')->search({id => $new_content->id})
      ->update({photos => "@photos"})
      if scalar @photos >= 1;

    $self->redirect_to('/cpanel/content/form?mode=update&id=' . $new_content->id);

};

any '/cpanel/content/update' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    my (@tags, @cities, @types, @interests, @pages, @photos);

    if (($self->param('start_date')) and ($self->param('start_time'))) {

        my $start_datetime = DateTime::Format::ISO8601->parse_datetime(
            $self->param('start_date') . $self->param('start_time'));


        my $stop_datetime = DateTime::Format::ISO8601->parse_datetime(
            $self->param('stop_date') . $self->param('stop_time'));

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({stop_datetime => $stop_datetime});

    }

    if ($self->param('author')) {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({author => $self->param('author')});
    }

    if ($self->param('title')) {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({title => $self->param('title')});
    }

    if ($self->param('body')) {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({body => encode_string($self->param('body'))});
    }

    if ($self->param('interests')) {

        push @interests, $_ for $self->param('interests');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({interests => "@interests"});
    }

    if ($self->param('pages')) {

        push @pages, $_ for $self->param('pages');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({pages => "@pages"});
    }

    if ($self->param('types')) {

        push @types, $_ for $self->param('types');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({types => "@types"});
    }

    if ($self->param('tags')) {

        push @tags, $_ for $self->param('tags');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({tags => "@tags"});
    }

    if ($self->param('cities')) {

        push @cities, $_ for $self->param('cities');

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({cities => "@cities"});
    }

    if ($self->param('position')) {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({position => $self->param('position')});
    }

    if ($self->param('link')) {
        
        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({link => $self->param('link')});
    }

    if ($self->param('address')) {

        my @results = google_local($self->param('address'));

        for (@results) {

            $MODEL->resultset('Content')->search({id => $self->param('id')})
              ->update(
                {   venue   => $_->title,
                    address => $_->streetAddress . ', ' . $_->city,
                    lat     => $_->lat,
                    lng     => $_->lng
                }
              );
        }
    }

    if ($self->param('venue')) {

        $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->update({venue => $self->param('venue')});
    }

    if ($self->param('default_photo')) {

        my $content =
          $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->single;

        @photos = split /\s+/, $content->photos;

        my $default = $self->param('default_photo');

        for (my $i = 0; $i <= scalar @photos; $i++) {

            delete $photos[$i] if $photos[$i] =~ m/^$default/i;
        }

        unshift @photos, $default;
    }

    push @photos,
      process_photo($self->req->upload('photos'), $self->param('id'))
      if $self->req->upload('photos');

    $MODEL->resultset('Content')->search({id => $self->param('id')})
      ->update({photos => "@photos"})
      if scalar @photos >= 1;

    $MODEL->resultset('Content')->search({id => $self->param('id')})
      ->update({modified_datetime => DateTime->now});


    my $id = $self->param('id');
    $self->redirect_to("/cpanel/content/form?mode=update&id=$id");


};

any '/cpanel/content/remove' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    try {

        my $content =
          $MODEL->resultset('Content')->search({id => $self->param('id')})
          ->single;
        my @content_photos = split /\s+/, $content->photos;

        unlink "public$_" for @content_photos;

        $content->delete;
    }

    finally {

        $self->redirect_to('cpanel');
    }

    #if ($self->param('photo')) {
    #
    #    my $photo_madness =
    #      $MODEL->resultset('Content')->search({id => $self->param('id')})
    #      ->single;
    #
    #    my @photos = split /\s+/, $photo_madness->photos;
    #
    #    my $checksum = $self->param('photo');
    #
    #    for (my $i = 0; $i <= scalar @photos; $i++) {
    #
    #        delete $photos[$i] if $photos[$i] =~ m/^$checksum/i
    #            and unlink "public/photos/$checksum";
    #    }
    #
    #   $MODEL->resultset('Content')->search({id => $self->param('id')})
    #      ->update({photos => "@photos"})
    #      if scalar @photos >= 1;
    #
    #}

};

## CPanel: After5 Admin

any '/cpanel/login' => sub {

    my $self = shift;

    try {

        my @settings =
          $MODEL->resultset('Settings')
          ->search({admin => $self->param('admin')});

        for (@settings) {

            if (Crypt::SaltedHash->validate(
                    $_->password, $self->param('password')
                )
              )
            {

                $self->session(admin => $_->admin);
                $self->redirect_to('cpanel');
            }
        }
    }

    finally {

        $self->redirect_to('cpanel');
    }

} => 'cpanel_login';

get '/cpanel/logout' => sub {

    my $self = shift;

    $self->session(expires => 1)
      and return $self->redirect_to('home');

} => 'cpanel_logout';

any '/cpanel/settings' => sub {

    my $self = shift;

    return $self->redirect_to('cpanel') unless $self->session('admin');

    try {

        $MODEL->resultset('Settings')
          ->update({admin => $self->param('admin')});

        if (    ($self->param('password_1') ne '')
            and ($self->param('password_1') eq $self->param('password_2')))
        {

            my $crypt = Crypt::SaltedHash->new(algorithm => 'SHA-256');
            $crypt->add($self->param('password_1'));

            my $password = $crypt->generate;

            $MODEL->resultset('Settings')->update({password => $password});
        }

        $MODEL->resultset('Settings')
          ->update({about => $self->param('about')});
    }

    finally {

        $self->redirect_to('cpanel');
    }

} => 'cpanel_settings';


### After5 Tools

sub process_photo {

    my ($upload, $id) = @_;

    my (@new_photos, @existing_photos, @processed_photos);

    if ($upload->filename =~ m/zip$/i) {

        my $zip_file = $upload->filename;
        $upload->move_to("/tmp/$zip_file");

        my $archive = Archive::Extract->new(archive => "/tmp/$zip_file");

        if ($archive->is_zip) {

            my $ok = $archive->extract(to => '/tmp/');

            for (@{$archive->files}) {

                my $checksum = Mojo::Util::md5_sum($_);
                my $path     = "/photos/$checksum.img";

                move "/tmp/$_", "public/$path"
                  unless -d "/tmp/$_";

                push @new_photos, $path;
            }
        }
    }
    else {

        my $checksum = Mojo::Util::md5_sum($upload->filename);
        my $path     = "/photos/$checksum.img";

        $upload->move_to('public' . $path);

        push @new_photos, $path;
    }

    my $content = $MODEL->resultset('Content')->search({id => $id})->single;
    @existing_photos = split /\s+/, $content->photos;

    for my $new (@new_photos) {

        next if -e "public/photos/$new";
        push @processed_photos, $new;
    }

    push @processed_photos, @existing_photos;
    return @processed_photos;

}

sub google_local {

    REST::Google::Search->service(LOCAL);

    my $response = REST::Google::Search->new(q => shift);

    if ($response->responseStatus == 200) {

        my $data = $response->responseData;
        return $data->results;
    }

}

sub randomize_content {

    my @array = shift;
    my $i     = $#array;
    my $j;

    for my $item (@array) {

        --$i;
        $j = int rand($i + 1);
        next if $i == $j;
        @array[$i, $j] = @array[$j, $i];
    }
    return \@array;

}

sub encode_string {

    return Encode::encode('ISO-8859-1', shift);
}

app->secret('after5detroit.com');
app->start;
